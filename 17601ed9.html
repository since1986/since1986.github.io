<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.2',
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: true,
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前言在上一篇文章「Spring Cloud与微服务学习笔记-基本概念」中，我们简要介绍了微服务和Spring Cloud的概念。在本篇文章中，我们将介绍微服务中不可或缺的组成部分：服务注册与发现，并且使用Spring Cloud Netflix中的Eureka组件来搭建一组服务注册与发现服务器。 什么是服务注册与发现关于这个问题，咱们来设想一个生活中的场景：小张晚上下班回家，饿了就要饿了么，然后拿">
<meta name="keywords" content="spring,spring-cloud">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud与微服务学习笔记-注册与发现">
<meta property="og:url" content="https://since1986.github.io/17601ed9.html">
<meta property="og:site_name" content="Since1986">
<meta property="og:description" content="前言在上一篇文章「Spring Cloud与微服务学习笔记-基本概念」中，我们简要介绍了微服务和Spring Cloud的概念。在本篇文章中，我们将介绍微服务中不可或缺的组成部分：服务注册与发现，并且使用Spring Cloud Netflix中的Eureka组件来搭建一组服务注册与发现服务器。 什么是服务注册与发现关于这个问题，咱们来设想一个生活中的场景：小张晚上下班回家，饿了就要饿了么，然后拿">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_17-16-38.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_17-23-47.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_17-31-38.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_17-45-48.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_15-46-59.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_15-47-38.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_15-44-13.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_18-11-15.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/eureka_architecture.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_15-44-13.png">
<meta property="og:image" content="https://since1986.github.io/17601ed9/archimedes.jpg">
<meta property="og:image" content="https://since1986.github.io/17601ed9/eureka1.jpg">
<meta property="og:image" content="https://since1986.github.io/17601ed9/eureka2.jpg">
<meta property="og:updated_time" content="2019-10-09T08:17:57.537Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Cloud与微服务学习笔记-注册与发现">
<meta name="twitter:description" content="前言在上一篇文章「Spring Cloud与微服务学习笔记-基本概念」中，我们简要介绍了微服务和Spring Cloud的概念。在本篇文章中，我们将介绍微服务中不可或缺的组成部分：服务注册与发现，并且使用Spring Cloud Netflix中的Eureka组件来搭建一组服务注册与发现服务器。 什么是服务注册与发现关于这个问题，咱们来设想一个生活中的场景：小张晚上下班回家，饿了就要饿了么，然后拿">
<meta name="twitter:image" content="https://since1986.github.io/17601ed9/Snipaste_2018-03-29_17-16-38.png">





  
  
  <link rel="canonical" href="https://since1986.github.io/17601ed9">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Spring Cloud与微服务学习笔记-注册与发现 | Since1986</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Since1986</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-notes">

    
    
    
      
    

    

    <a href="/notes/" rel="section"><i class="menu-item-icon fa fa-fw fa-sticky-note-o"></i> <br>notes</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/since1986" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://since1986.github.io/17601ed9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="since1986">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar215x215.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Since1986">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring Cloud与微服务学习笔记-注册与发现

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-03-28 10:41:39" itemprop="dateCreated datePublished" datetime="2018-03-28T10:41:39+08:00">2018-03-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-10-09 16:17:57" itemprop="dateModified" datetime="2019-10-09T16:17:57+08:00">2019-10-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">13k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">12 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在上一篇文章<a href="https://since1986.github.io/blog/8b1aa30e.html">「Spring Cloud与微服务学习笔记-基本概念」</a>中，我们简要介绍了微服务和Spring Cloud的概念。在本篇文章中，我们将介绍微服务中不可或缺的组成部分：服务注册与发现，并且使用Spring Cloud Netflix中的Eureka组件来搭建一组服务注册与发现服务器。</p>
<h2 id="什么是服务注册与发现"><a href="#什么是服务注册与发现" class="headerlink" title="什么是服务注册与发现"></a>什么是服务注册与发现</h2><p>关于这个问题，咱们来设想一个生活中的场景：小张晚上下班回家，饿了<del>就要饿了么</del>，然后拿起了手机，点开<del>美团</del>外卖软件，从中翻了一翻，在饭店列表中看到了一家新店：“老李肉夹馍”，心想，刚好要吃肉夹馍，就这家吧，下单，等吃；另一边，前不久，老板老李，新开了一家店：老李肉夹馍，老李知道外卖能给自己的店带来生意，于是在外卖平台上注册了自己的店，这几天果然生意兴隆，刚刚老李看到了小明下的单，然后接单，做饭。这个场景中，老张是服务的提供方，而小张是服务的消费方，而老李向外卖平台注册后，小张就能够发现并消费老李提供的服务了，这个外卖平台其实就是提供了“服务注册与发现”。</p>
<h2 id="为什么要有“服务注册与发现”"><a href="#为什么要有“服务注册与发现”" class="headerlink" title="为什么要有“服务注册与发现”"></a>为什么要有“服务注册与发现”</h2><p>那么，为什么微服务需要服务注册与发现呢？因为没有服务注册与发现会很麻烦的，还是以一个例子来说明吧：平常我们经常会访问各种各样的网站，试想一下，如果访问每一个网站都需要记住很长的一串IP地址的话，那访问起来会有多不方便，况且，网站的IP也不可能自始至终就那莫一个，一旦变化了，难道作为网站的经营者要通知所有忠实的用户新的IP地址是多少吗，好在，我们有DNS这种注册与发现服务，前边说的那些情况，DNS这种注册与发现服务就默默的帮我们处理了。对于微服务也是如此，假如A会消费B的服务，你可以A中硬编码B服务的调用地址的方式来记住调用的路径，但是一旦B的部署环境发生改变，A岂不是也要跟着改，这样变来变去会烦死的，更何况B有可能会有多个实例，A想要消费B就需要从B的众多实例中选出一个来消费，就更不可能用硬编码记住地址这种方式调用了，所以需要有类似于DNS能注册与发现IP地址这样的注册与发现服务来帮助我们去处理这些繁琐的细节。</p>
<h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><p>那么，在Spring Cloud体系中，是如何实现注册与发现的呢？Spring Cloud复用了现有的解决方案，支持接入三种成熟的注册与发现的解决方案：<a href="https://zookeeper.apache.org/" target="_blank" rel="noopener">Zookeeper</a>、<a href="https://www.consul.io/" target="_blank" rel="noopener">Consul</a>和<a href="https://github.com/Netflix/eureka" target="_blank" rel="noopener">Eureka</a>，这三种解决方案可以按照需要自己选择（Spring Cloud推荐Eureka），并且Spring Cloud提供了统一的接口来屏蔽他们的区别。</p>
<p>由于我们选择了使用Spring Cloud Netflix体系来实现微服务，而Eureka是包含在Spring Cloud Netflix体系中的，所以我们选择使用Eureka来做注册与发现。</p>
<h3 id="Eureka的概念"><a href="#Eureka的概念" class="headerlink" title="Eureka的概念"></a>Eureka的概念</h3><p>什么是Eureka呢？来看<a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance" target="_blank" rel="noopener">官方的介绍</a>：</p>
<blockquote>
<p>What is Eureka?</p>
<p>Eureka is a REST (Representational State Transfer) based service that is primarily used in the AWS cloud for locating services for the purpose of load balancing and failover of middle-tier servers. We call this service, the Eureka Server. Eureka also comes with a Java-based client component,the Eureka Client, which makes interactions with the service much easier. The client also has a built-in load balancer that does basic round-robin load balancing. At Netflix, a much more sophisticated load balancer wraps Eureka to provide weighted load balancing based on several factors like traffic, resource usage, error conditions etc to provide superior resiliency.</p>
</blockquote>
<p>大致的意思是Eureka是基于REST的，主要目的用于AWS云服务（<a href="https://aws.amazon.com" target="_blank" rel="noopener">Amazon Web Services</a>）上服务注册与发现、负载均衡和故障转移的中间层服务器。Eureka包含了服务器端和客户端两部分，其中客户端内置了负载均衡。</p>
<h3 id="如何使用Eureka"><a href="#如何使用Eureka" class="headerlink" title="如何使用Eureka"></a>如何使用Eureka</h3><p>如何使用Eureka呢？如果没有Spring Cloud，我们需要配置好一组Eureka服务器，然后在我们的服务中加入Eureka客户端,然后调用客户端API就行了（可以看官方给的<a href="https://github.com/Netflix/eureka/tree/master/eureka-examples" target="_blank" rel="noopener">例子</a>）。当然，有了Spring Cloud后，我们不用这么做了，Spring Cloud给Eureka做了一层包装，服务器端可以以Spring Boot程序的形式来跑，而客户端则不需显式调用API了，由Spring Cloud提供了统一的声明式接入的方法接入就可以了。</p>
<h3 id="用Eureka来做服务注册与发现的demo"><a href="#用Eureka来做服务注册与发现的demo" class="headerlink" title="用Eureka来做服务注册与发现的demo"></a>用Eureka来做服务注册与发现的demo</h3><p>说归说，练归连，想要用的起来，还得实际动手，我们开始吧。我会做两个demo，一个是最基本的单实例eureka server + 单实例service的例子，另一个是多实例eureka server + 多实例service的例子。</p>
<h4 id="单实例eureka-server-单实例service"><a href="#单实例eureka-server-单实例service" class="headerlink" title="单实例eureka server + 单实例service"></a>单实例eureka server + 单实例service</h4><p>我们来新建一个多模块的Gradle工程，包含3个模块：eureka-sever、service-a、service-b，分别对应了Eureka服务器和两个服务。（<a href="https://github.com/since1986/eureka-single-instance" target="_blank" rel="noopener">全部代码在我的Github上</a>）</p>
<p>先来写Eureka服务器，Spring Cloud对Eureka进行了包装，可以将eureka server做成一个Spring Boot应用，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//eureka-server模块构建配置</span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile group: &apos;org.springframework.cloud&apos;, name: &apos;spring-cloud-starter-eureka-server&apos;, version: &apos;1.4.0.RELEASE&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//eureka-server模块主启动</span></span><br><span class="line"><span class="keyword">package</span> com.github.since1986.learn.cloud.eureka.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.builder.SpringApplicationBuilder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> SpringApplicationBuilder(App.class).web(<span class="keyword">true</span>).run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//eureka-server模块主配置</span></span><br><span class="line"><span class="keyword">package</span> com.github.since1986.learn.cloud.eureka.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Spring Cloud配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">com-github-since1986-learn-cloud-eureka-server</span> <span class="comment">#注意命名要符合RFC 2396，否则会影响服务发现 详见https://stackoverflow.com/questions/37062828/spring-cloud-brixton-rc2-eureka-feign-or-rest-template-configuration-not-wor</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span> <span class="comment">#这里配置eureka相关</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">localhost</span> <span class="comment">#服务器实例主机名</span></span><br><span class="line"><span class="attr">  client:</span> <span class="comment">#客户端配置</span></span><br><span class="line"><span class="attr">    registerWithEureka:</span> <span class="literal">false</span> <span class="comment">#由于只有一个服务器实例，我们没必要自己注册自己了</span></span><br><span class="line"><span class="attr">    fetchRegistry:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>

<p>至此，我们已经配置好了一个Eureka服务器的实例，大家注意主配置中的<code>@EnableEurekaServer</code>，在Java中我们只需要加这一个注解就好了，一行代码也不用写，其他的都是<code>starter</code>和<code>application.yml</code>配置中的事了，是不是很方便。</p>
<p>再来看service（我们以service-a为例，service-b与service-a类似，就不复述了）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//service-a 构建配置</span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile group: &apos;org.springframework.cloud&apos;, name: &apos;spring-cloud-starter-netflix-eureka-client&apos;, version: &apos;1.4.0.RELEASE&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//service-a主启动</span></span><br><span class="line"><span class="keyword">package</span> com.github.since1986.learn.cloud.service.a;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.netflix.appinfo.InstanceInfo;</span><br><span class="line"><span class="keyword">import</span> com.netflix.discovery.EurekaClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.EnableScheduling;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaClient eurekaClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">App</span><span class="params">(EurekaClient eurekaClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.eurekaClient = eurekaClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(initialDelay = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">3</span>, fixedRate = <span class="number">1000</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printInstanceInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        InstanceInfo instanceInfo = eurekaClient.getNextServerFromEureka(<span class="string">"com-github-since1986-learn-cloud-service-b"</span>, <span class="keyword">false</span>);</span><br><span class="line">        System.out.println(String.format(<span class="string">"发现了 服务名为 %s IP为 %s 的服务."</span>, instanceInfo.getAppName(), instanceInfo.getIPAddr()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#Spring Cloud配置</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: com-github-since1986-learn-cloud-service-a</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8002</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8001/eureka/</span><br></pre></td></tr></table></figure>

<p>同样，我们还来看主启动，由于我们想测试一下是否能发现别的服务，所以在住启动文件里，我们写了一些调用<code>EurekaClient</code>来做发现的代码，除去这些代码，实际上作为一个普通service，我们在Java中不用写任何特殊的代码，只要配置好<code>starter</code>和<code>application.yml</code>就自动会注册与发现了，太省心了😆</p>
<p>写好了Eureka服务器和两个service，我们来启动，看一下效果吧，如下图所示我们把三个模块分别建立启动配置：</p>
<img src="/17601ed9/Snipaste_2018-03-29_17-16-38.png">

<p>然后启动，访问我们在<code>application.yml</code>中设置好的Eureka服务器的地址，然后可以看到Spring Cloud为Eureka服务器做的内置的UI，上边可以看到在服务器上注册了哪些service实例。</p>
<img src="/17601ed9/Snipaste_2018-03-29_17-23-47.png">

<p>然后，回过头来，我们来看service-a中我们写的测试服务发现的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled</span>(initialDelay = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">3</span>, fixedRate = <span class="number">1000</span> * <span class="number">30</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printInstanceInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    InstanceInfo instanceInfo = eurekaClient.getNextServerFromEurek(<span class="string">"com-github-since1986-learn-cloud-service-b"</span>, <span class="keyword">false</span>);</span><br><span class="line">    System.out.println(String.format(<span class="string">"发现了 服务名为 %s IP为 %s 的服务."</span>, instanceInfo.getAppName(), instanceInfo.getIPAddr()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，我们每30秒尝试发现名为<code>com-github-since1986-learn-cloud-service-b</code>的服务的名字和IP，其中<code>com-github-since1986-learn-cloud-service-b</code>是服务service-b在Eureka中注册的名字，如果正确的话，会在标准输出中输出发现的service-b的名字与IP</p>
<img src="/17601ed9/Snipaste_2018-03-29_17-31-38.png">

<p>至此，我们就完成了一个初步的注册与发现了，在Spring Boot/Cloud体系中的注册与发现是不是非常简单啊😜</p>
<h4 id="多实例eureka-server-多实例service"><a href="#多实例eureka-server-多实例service" class="headerlink" title="多实例eureka server + 多实例service"></a>多实例eureka server + 多实例service</h4><p>完成了单实例的注册与发现，我们再来看一下多实例的（<a href="https://github.com/since1986/eureka-multiple-instances" target="_blank" rel="noopener">全部代码在我的Github上</a>）</p>
<p>多个实例与单实例只在<code>application.yml</code>中有所不同，其他的代码区别不大，就不贴了，看一下<code>application.yml</code>吧。</p>
<p>eureka-server的<code>application.yml</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  profiles: eureka1</span><br><span class="line">  application:</span><br><span class="line">    name: com-github-since1986-learn-cloud-eureka-server #注意命名要符合RFC 2396，否则会影响服务发现 详见https://stackoverflow.com/questions/37062828/spring-cloud-brixton-rc2-eureka-feign-or-rest-template-configuration-not-wor</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8001</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: eureka1</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://eureka2:8002/eureka/,http://eureka3:8003/eureka/</span><br><span class="line">    register-with-eureka: true #需要配置这一项才生效（虽然默认这个配置是true，但是可能默认配置被覆盖掉了所以未生效）</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  profiles: eureka2</span><br><span class="line">  application:</span><br><span class="line">    name: com-github-since1986-learn-cloud-eureka-server #注意命名要符合RFC 2396，否则会影响服务发现 详见https://stackoverflow.com/questions/37062828/spring-cloud-brixton-rc2-eureka-feign-or-rest-template-configuration-not-wor</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8002</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: eureka2</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://eureka1:8001/eureka/,http://eureka3:8003/eureka/</span><br><span class="line">    register-with-eureka: true #需要配置这一项才生效（虽然默认这个配置是true，但是可能默认配置被覆盖掉了所以未生效）</span><br><span class="line">---</span><br><span class="line">spring:</span><br><span class="line">  profiles: eureka3</span><br><span class="line">  application:</span><br><span class="line">    name: com-github-since1986-learn-cloud-eureka-server #注意命名要符合RFC 2396，否则会影响服务发现 详见https://stackoverflow.com/questions/37062828/spring-cloud-brixton-rc2-eureka-feign-or-rest-template-configuration-not-wor</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8003</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: eureka3</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://eureka1:8001/eureka/,http://eureka2:8002/eureka/</span><br><span class="line">    register-with-eureka: true #需要配置这一项才生效（虽然默认这个配置是true，但是可能默认配置被覆盖掉了所以未生效）</span><br></pre></td></tr></table></figure>

<p>这段配置比较长，仔细看一下，这其实包含了三段类似重复的配置，中间以<code>---</code>分割，并且每一段中都有<code>profiles: eureka&lt;n&gt;</code>这个配置项，这其实是配置了一个Spring Cloud的<code>profile</code>，这个配置文件里有3个<code>profile</code>，实际上也就是配置了3个实例节点，在idea的运行配置中我们选择激活某一个<code>profile</code>，就会启动对用的节点，这样，我们只要配置多个启动项就可以在一套工程里启动3个实力节点了。</p>
<img src="/17601ed9/Snipaste_2018-03-29_17-45-48.png">

<p>然后再来注意每一个<code>profile</code>中<code>defaultZone</code>这一配置项，在多实例的情境下，我们让每一个Eureka服务器都在集群中的其他服务器上注册，集群中的所有服务器会相互同步状态，这样即便一台服务器掉了，还有其他的服务器顶着，这样就保证了注册与发现服务的可用性，这也是我们要配置多实例的原因。</p>
<p>另外还有一点需要注意的，由于咱们是在本地机器上做测试，所以所有Eureka服务器的机器名是相同的，然而要想让多个实例跑起来主机名是不能相同的，参见<code>hostname</code>配置项，这就很矛盾了，但是我们也有办法解决，修改本机的<code>hosts</code>文件就好了，让本机新加出三个不同的host name出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#hosts配置</span><br><span class="line">127.0.0.1	eureka1</span><br><span class="line">127.0.0.1	eureka2</span><br><span class="line">127.0.0.1	eureka3</span><br></pre></td></tr></table></figure>

<p>做好了这些，3个Eureka服务器实例就可以跑起来了，service-a和service-b也是如法炮制就好了。最后，我们会一共跑起来3*3=9个实例（我的机子内存小，一下跑起来9个实例感觉机子会卡 😅）</p>
<p>启动起来我们照样，看一下Eureka的UI：</p>
<img src="/17601ed9/Snipaste_2018-03-29_15-46-59.png">

<img src="/17601ed9/Snipaste_2018-03-29_15-47-38.png">

<p>可以看到，连上服务器自身，所有service都被注册了上去，同时，3个Eureka实例也是相互备份的：（可以停掉某个服务，然后刷新这个UI看看变化）</p>
<img src="/17601ed9/Snipaste_2018-03-29_15-44-13.png">

<p>我们还可以操作Eureka服务器提供的REST API来手工控制注册与发现.（API列表见<a href="https://github.com/Netflix/eureka/wiki/Eureka-REST-operations" target="_blank" rel="noopener">官方文档</a>）</p>
<p>调用<code>/eureka/apps</code>可以看到所有注册的服务的信息</p>
<img src="/17601ed9/Snipaste_2018-03-29_18-11-15.png">

<p>同时，我们再来注意测试服务发现的代码，这里略有不同了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scheduled</span>(initialDelay = <span class="number">1000</span> * <span class="number">10</span>, fixedRate = <span class="number">1000</span> * <span class="number">30</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printInstanceInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;InstanceInfo&gt; instanceInfos = eurekaClient.getInstancesByVipAddress(<span class="string">"com-github-since1986-learn-cloud-service-b"</span>, <span class="keyword">false</span>);</span><br><span class="line">    instanceInfos.forEach(instanceInfo -&gt; &#123;</span><br><span class="line">        System.out.printf(<span class="string">"发现了 %s: %s \n"</span>, instanceInfo.getAppName(), instanceInfo.getIPAddr());</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这回由于是多实例了，所以我们由一个服务注册名能发现多个实例，作为实验，你可以停掉其中某个实例，来看看会有什么变化。</p>
<h3 id="深入了解Eureka"><a href="#深入了解Eureka" class="headerlink" title="深入了解Eureka"></a>深入了解Eureka</h3><p>Eureka为我们的微服务提供了注册与发现服务，大多数情况下，我们只要用就好了，但是，一旦在使用过程中遇到了问题，如果不知道其运作的机理，我们肯定会两眼一抹黑，不知道解决问题的方向。因此，让我们来通过阅读官方文档大致了解一下Eureka运作的机理吧。</p>
<h4 id="Eureka高层架构"><a href="#Eureka高层架构" class="headerlink" title="Eureka高层架构"></a>Eureka高层架构</h4><p>我们来看官方给出的High level architecture，也就是高层架构（所谓高层架构我理解的就是相对于源码级实现的架构，在逻辑层面的架构）的说明：</p>
<blockquote>
<p>High level architecture</p>
<img src="/17601ed9/eureka_architecture.png">

<p>The architecture above depicts how Eureka is deployed at Netflix and this is how you would typically run it. There is one eureka cluster per region which knows only about instances in its region. There is at the least one eureka server per zone to handle zone failures.</p>
<p>Services register with Eureka and then send heartbeats to renew their leases every 30 seconds. If the client cannot renew the lease for a few times, it is taken out of the server registry in about 90 seconds. The registration information and the renewals are replicated to all the eureka nodes in the cluster. The clients from any zone can look up the registry information (happens every 30 seconds) to locate their services (which could be in any zone) and make remote calls.</p>
</blockquote>
<p>先来看第一段，大致意思是：在每一个region（AWS”区域”）中只跑一个Eureka的cluster（集群），每个region中的Eureka cluster只负责自己region中的instance（实例）（？这一点官方没说的太明白是什么实例，我理解的是”服务实例”），在region中下分的每一个zone（AWS”可用区域”）里至少包含一个eureka server，来保证可用性（因为zone是AWS中保证可用性的单元，也就是说在同一个region下各个zone可用性是相互独立的，一个zone掉线了不会影响另一个zone，这样就保证了可用性）。</p>
<p>在这段官方文档里面出现的region和zone的概念都是<a href="https://docs.aws.amazon.com/zh_cn/AWSEC2/latest/UserGuide/using-regions-availability-zones.html" target="_blank" rel="noopener">AWS中的概念</a>。因为Eureka设计之初就是为了跑在AWS上的，所以会有这些AWS的概念，我们在开发自己的服务时，想必不会跑在AWS上的，也不必过于纠结与具体概念，这一点，Spring Cloud通过提供默认值的方式替我们处理好了，在Spring Cloud的Eureka客户端集成处理中，为region默认设置提供了”us-east-1”这个值，为zone默认提供了了”defaultZone”这个值，也就是说除非你十分需要，否则不再用手动设置region和zone了，用默认值就好了，这也体现了”约定先于配置”的理念（参看源码<a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/master/spring-cloud-netflix-eureka-client/src/main/java/org/springframework/cloud/netflix/eureka/EurekaClientConfigBean.java" target="_blank" rel="noopener">org.springframework.cloud.netflix.eureka.EurekaClientConfigBean</a>）。如果实在需要保证极高的可用性的话，大可以参照AWS的region和zone的概念来设计架构并且自行配置eureka的region和zone。（在官方给出的架构图实例说明中，只用到了一个region：us-east-1，分为了3个zone：us-east-1c、us-east-1d、us-east-1e，每一个zone上都是一个eureka server实例）</p>
<p>再来看第二段，大致的意思是：服务注册到eureka server上以后，每30秒发送一次心跳以刷新租约，如果发现在90内没有心跳发送了，服务器会注销此服务的注册信息。注册信息每30秒会在eureka server集群中的各个节点复制。另外服务的发现可以跨zone进行。这一段里没有什么晦涩的概念，大致告诉我们了服务注册是以怎样的模式运作的，知道就好了。</p>
<h4 id="了解服务消费端与服务提供端的通讯"><a href="#了解服务消费端与服务提供端的通讯" class="headerlink" title="了解服务消费端与服务提供端的通讯"></a>了解服务消费端与服务提供端的通讯</h4><blockquote>
<p>How does the application client and application server communicate?</p>
<p>The communication technology could be anything you like. Eureka helps you find the information about the services you would want to communicate with but does not impose any restrictions on the protocol or method of communication. For instance, you can use Eureka to obtain the target server address and use protocols such as thrift, http(s) or any other RPC mechanisms.</p>
</blockquote>
<p>从上边的官方文档中，我们可以看到：Eureka并不会干预服务之间的通讯协议的选择，随便你用RPC、http还是什么方式，Eureka只管帮一个服务发现想要通讯的另一个目标服务，至于发现之后两者之间怎样建立通讯，Eureka就不管了。</p>
<h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><p>我们在前面做实例时，会发现，Eureka包含了多实例集群的配置启动方式，实际上，在生产环境中，我们一般也不会只跑单实例的，可是，为什么要这样设计呢？是为了预防“单点故障”，那么，“单点故障”是什么呢。</p>
<h3 id="关于“单点故障”"><a href="#关于“单点故障”" class="headerlink" title="关于“单点故障”"></a>关于“单点故障”</h3><p>single point of failure，（单点故障，缩写SPOF）是指系统中某一部件一旦失效，就会让整个系统都无法运作，换句话说，单点故障即会导致整体故障。其实通俗一点，就是“把所有鸡蛋都放在了一个篮子里”。</p>
<p>那么如何解决“单点故障”问题？“不要把鸡蛋放在一个篮子里”就好了。“一个篮子”就是单点，而一个篮子变成多个篮子就是“冗余”（“replicate”），而冗余则是解决单点问题的核心思路。我们可以回想一下在做demo时，多实例Eureka服务器UI界面中<code>available-replicas</code>，这个就是现实的当前这个服务器的冗余。</p>
<img src="/17601ed9/Snipaste_2018-03-29_15-44-13.png">

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本篇文章中我们学习了在Spring Cloud中怎样做服务注册与发现，并且以两个demo来实践了一下，在下一篇文章<a href="https://since1986.github.io/blog/fe76b270.html">「Spring Cloud与微服务学习笔记-服务调用（上）」</a>中，我们会学习怎样调用已经发现的服务。</p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><p><a href="http://tech.lede.com/2017/03/29/rd/server/SpringCloud1C/" target="_blank" rel="noopener">Spring Cloud技术分析（2）—— 服务治理实践 </a></p>
<p><a href="http://dbanotes.net/web/web_single_point_of_failure.html" target="_blank" rel="noopener">消除小型 Web 站点单点故障(Single Point of Failure)</a></p>
<p><a href="https://www.jianshu.com/p/9c465baab4ce" target="_blank" rel="noopener">单点故障</a></p>
<p><a href="https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication" target="_blank" rel="noopener">Understanding eureka client server communication</a></p>
<p><a href="http://tech.lede.com/2017/03/15/rd/server/SpringCloud1/" target="_blank" rel="noopener">Spring Cloud技术分析（1）——服务治理 </a></p>
<p><a href="https://www.zhihu.com/question/266147523/answer/307121571" target="_blank" rel="noopener">有没有什么单词让你心里一动？</a></p>
<p><a href="https://segmentfault.com/a/1190000008826496" target="_blank" rel="noopener">服务注册与发现</a></p>
<p><a href="https://jpanj.com/2017/%E5%9F%BA%E4%BA%8E-Eureka-%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E7%8E%B0%E8%B0%83%E7%A0%94/" target="_blank" rel="noopener">基于 Eureka 的服务注册与发现调研</a></p>
<p><a href="http://fanlychie.github.io/post/spring-cloud-netflix-eureka.html" target="_blank" rel="noopener">Spring Cloud Eureka — 服务发现</a></p>
<p><a href="https://yangdongdong.org/2017/12/20/spring-cloud-eureka/" target="_blank" rel="noopener">Spring Cloud Eureka：服务注册与发现</a></p>
<p><a href="https://github.com/Netflix/eureka/wiki/Eureka-at-a-glance" target="_blank" rel="noopener">Eureka at a glance</a></p>
<p><a href="https://blog.csdn.net/forezp/article/details/73017664" target="_blank" rel="noopener">深入理解Eureka之源码解析</a></p>
<h2 id="彩蛋"><a href="#彩蛋" class="headerlink" title="彩蛋"></a>彩蛋</h2><p>有没有想过，为什么网飞给自己的服务发现与注册组件起名为“Eureka”呢？，一个很文艺的名字。其实这里边是有一个<a href="http://archimedespalimpsest.org/images/kaltoon/" target="_blank" rel="noopener">梗</a>的。</p>
<p>Eureka（希腊语：εὕρηκα；拉丁化：Eureka；词义：“我发现了”）据传，阿基米德在洗澡时发现浮力原理，高兴得来不及穿上裤子，跑到街上大喊：“Eureka(我发现了)！”（实际上这个梗是演绎的，真实情况是这样的：<a href="http://www.quanminyingyu.com/index/play/play.html?id=1131" target="_blank" rel="noopener">The real story behind Archimedes’ Eureka!</a>）。</p>
<img src="/17601ed9/archimedes.jpg">

<img src="/17601ed9/eureka1.jpg">

<p>网飞的开发人员取了这个“发现”的典故来为自己的产品命名，不得不说还挺有才学和浪漫精神的。这里插一句题外话：其实不只是网飞用过“Eureka”这个梗，在前两年的一部影视作品《星际穿越》中也使用了“Eureka”这个桥段，在影片中，墨菲解出了方程式后，挥洒稿纸，激动地喊出了：“Eureka”，感兴趣的同学可以回去重温一下这部经典的片子，并且留意一下这个桥段。</p>
<img src="/17601ed9/eureka2.jpg">

      
    </div>

    

    
    
    

    

    
      
    
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>since1986</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="https://since1986.github.io/17601ed9.html" title="Spring Cloud与微服务学习笔记-注册与发现">https://since1986.github.io/17601ed9.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        
          
        
        <div class="post-tags">
          
            <a href="/tags/spring/" rel="tag"># spring</a>
          
            <a href="/tags/spring-cloud/" rel="tag"># spring-cloud</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/1b3b8e8b.html" rel="next" title="发现一个讲解Raft协议的动画">
                <i class="fa fa-chevron-left"></i> 发现一个讲解Raft协议的动画
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/20aae457.html" rel="prev" title="用sed、tail、egrep、less在日志中定位异常">
                用sed、tail、egrep、less在日志中定位异常 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar215x215.png" alt="since1986">
            
              <p class="site-author-name" itemprop="name">since1986</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">151</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/since1986" title="GitHub &rarr; https://github.com/since1986" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:385741668@qq.com" title="E-Mail &rarr; mailto:385741668@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/_since1986_" title="Twitter &rarr; https://twitter.com/_since1986_" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.linkedin.com/in/fan-zhang-since1986" title="Linkedin &rarr; https://www.linkedin.com/in/fan-zhang-since1986" rel="noopener" target="_blank"><i class="fa fa-fw fa-linkedin"></i>Linkedin</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://since1986.github.io/" title="https://since1986.github.io/">我的主站</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://since1986.coding.me/" title="https://since1986.coding.me/" rel="noopener" target="_blank">我的高速镜像站</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.720ui.com/" title="http://blog.720ui.com/" rel="noopener" target="_blank">梁桂钊的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://chenyongjun.vip/" title="http://chenyongjun.vip/" rel="noopener" target="_blank">码代码的陈同学</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://qixiaobo.site/" title="https://qixiaobo.site/" rel="noopener" target="_blank">后端之路</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xilidou.com/" title="https://xilidou.com/" rel="noopener" target="_blank">犀利豆的博客</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是服务注册与发现"><span class="nav-number">2.</span> <span class="nav-text">什么是服务注册与发现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要有“服务注册与发现”"><span class="nav-number">3.</span> <span class="nav-text">为什么要有“服务注册与发现”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Eureka"><span class="nav-number">4.</span> <span class="nav-text">Eureka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Eureka的概念"><span class="nav-number">4.1.</span> <span class="nav-text">Eureka的概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何使用Eureka"><span class="nav-number">4.2.</span> <span class="nav-text">如何使用Eureka</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用Eureka来做服务注册与发现的demo"><span class="nav-number">4.3.</span> <span class="nav-text">用Eureka来做服务注册与发现的demo</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#单实例eureka-server-单实例service"><span class="nav-number">4.3.1.</span> <span class="nav-text">单实例eureka server + 单实例service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多实例eureka-server-多实例service"><span class="nav-number">4.3.2.</span> <span class="nav-text">多实例eureka server + 多实例service</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#深入了解Eureka"><span class="nav-number">4.4.</span> <span class="nav-text">深入了解Eureka</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Eureka高层架构"><span class="nav-number">4.4.1.</span> <span class="nav-text">Eureka高层架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#了解服务消费端与服务提供端的通讯"><span class="nav-number">4.4.2.</span> <span class="nav-text">了解服务消费端与服务提供端的通讯</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展阅读"><span class="nav-number">5.</span> <span class="nav-text">扩展阅读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于“单点故障”"><span class="nav-number">5.1.</span> <span class="nav-text">关于“单点故障”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">6.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料："><span class="nav-number">7.</span> <span class="nav-text">参考资料：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#彩蛋"><span class="nav-number">8.</span> <span class="nav-text">彩蛋</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2011 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">since1986</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">452k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">6:51</span>
  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.2</div>




        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/affix.js?v=7.1.2"></script>

  <script src="/js/schemes/pisces.js?v=7.1.2"></script>



  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  
  <script src="/js/js.cookie.js?v=7.1.2"></script>
  <script src="/js/scroll-cookie.js?v=7.1.2"></script>


  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
